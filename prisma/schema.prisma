generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────
// Enums
// ──────────────────────────────────────

enum UserRole {
  ADMIN
  MANAGER
  FINANCE
  MEMBER
  VIEWER
}

enum ProjectType {
  INTERIOR_DESIGN
  CONFERENCE_DECOR
  EXHIBITION
  INSTALLATION
  EXPERIENTIAL
  OTHER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  REIMBURSED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  WRITTEN_OFF
}

enum PaymentTerms {
  DUE_ON_RECEIPT
  NET_15
  NET_30
  NET_60
  MILESTONE
}

enum VendorCategory {
  FABRICATION
  PRINTING
  CATERING
  AV
  FLORAL
  LIGHTING
  FURNITURE
  STAFFING
  TRANSPORT
  PHOTOGRAPHY
  SIGNAGE
  OTHER
}

// ──────────────────────────────────────
// Core Models (Phase 1)
// ──────────────────────────────────────

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  email     String?
  website   String?
  logoUrl   String?
  currency  String   @default("USD")
  taxRateBasisPoints Int @default(0) // e.g. 1600 = 16.00%
  invoicePrefix      String @default("INV")
  invoiceNextNumber  Int    @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  teams        Team[]
  projects     Project[]
  vendors      Vendor[]
  activityLogs ActivityLog[]

  @@index([slug])
}

model User {
  id             String    @id @default(cuid())
  organizationId String
  email          String    @unique
  name           String
  passwordHash   String?
  avatarUrl      String?
  role           UserRole  @default(MEMBER)
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  accounts       Account[]
  sessions       Session[]
  teamMembers    TeamMember[]
  assignedTasks  Task[]       @relation("TaskAssignee")
  createdTasks   Task[]       @relation("TaskCreator")
  submittedExpenses Expense[] @relation("ExpenseSubmitter")
  approvedExpenses  Expense[] @relation("ExpenseApprover")
  activityLogs     ActivityLog[]
  comments         Comment[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Team {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  members      TeamMember[]
  projects     ProjectTeam[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  joinedAt  DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

// ──────────────────────────────────────
// Project Models (Phase 2)
// ──────────────────────────────────────

model Project {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           ProjectType
  status         ProjectStatus @default(DRAFT)
  clientName     String?
  clientEmail    String?
  clientPhone    String?
  clientAddress  String?
  startDate      DateTime?
  endDate        DateTime?
  archivedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  milestones   Milestone[]
  teams        ProjectTeam[]
  vendors      ProjectVendor[]
  budgets      Budget[]
  expenses     Expense[]
  invoices     Invoice[]
  files        ProjectFile[]
  activityLogs ActivityLog[]
  comments     Comment[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, type])
}

model ProjectTeam {
  id        String @id @default(cuid())
  projectId String
  teamId    String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([projectId, teamId])
}

model Milestone {
  id        String   @id @default(cuid())
  projectId String
  name      String
  description String?
  sortOrder Int      @default(0)
  dueDate   DateTime?
  completedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@index([projectId])
  @@index([projectId, sortOrder])
}

model Task {
  id          String       @id @default(cuid())
  milestoneId String
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assigneeId  String?
  creatorId   String
  dueDate     DateTime?
  completedAt DateTime?
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  milestone Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  assignee  User?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator   User      @relation("TaskCreator", fields: [creatorId], references: [id])

  @@index([milestoneId])
  @@index([assigneeId])
  @@index([milestoneId, status])
}

model Vendor {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  category       VendorCategory
  email          String?
  phone          String?
  address        String?
  website        String?
  contactName    String?
  notes          String?
  rating         Int?           // 1-5
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id])
  projects     ProjectVendor[]
  expenses     Expense[]

  @@index([organizationId])
  @@index([organizationId, category])
}

model ProjectVendor {
  id        String @id @default(cuid())
  projectId String
  vendorId  String

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([projectId, vendorId])
}

model ProjectFile {
  id        String   @id @default(cuid())
  projectId String
  name      String
  mimeType  String
  sizeBytes Int
  storageKey String  // key in storage provider
  uploadedById String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Comment {
  id        String   @id @default(cuid())
  projectId String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([projectId])
}

model ActivityLog {
  id             String   @id @default(cuid())
  organizationId String
  projectId      String?
  userId         String?
  action         String   // e.g. "project.created", "expense.approved"
  entityType     String   // e.g. "Project", "Expense", "Invoice"
  entityId       String
  metadata       Json?    // Additional context
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  project      Project?     @relation(fields: [projectId], references: [id])
  user         User?        @relation(fields: [userId], references: [id])

  @@index([organizationId, createdAt])
  @@index([projectId, createdAt])
  @@index([entityType, entityId])
}

// ──────────────────────────────────────
// Financial Models (Phase 3)
// ──────────────────────────────────────

model Budget {
  id             String   @id @default(cuid())
  projectId      String
  totalAmountCents Int
  approvedAt     DateTime?
  approvedById   String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project    Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  categories BudgetCategory[]

  @@index([projectId])
}

model BudgetCategory {
  id               String @id @default(cuid())
  budgetId         String
  name             String
  allocatedCents   Int
  sortOrder        Int    @default(0)

  budget   Budget    @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  expenses Expense[]

  @@index([budgetId])
}

model Expense {
  id               String        @id @default(cuid())
  organizationId   String
  projectId        String
  budgetCategoryId String?
  vendorId         String?
  description      String
  amountCents      Int
  date             DateTime
  status           ExpenseStatus @default(DRAFT)
  submittedById    String
  approvedById     String?
  approvedAt       DateTime?
  rejectionReason  String?
  notes            String?
  deletedAt        DateTime?     // Soft delete for financial records
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  project        Project         @relation(fields: [projectId], references: [id])
  budgetCategory BudgetCategory? @relation(fields: [budgetCategoryId], references: [id])
  vendor         Vendor?         @relation(fields: [vendorId], references: [id])
  submittedBy    User            @relation("ExpenseSubmitter", fields: [submittedById], references: [id])
  approvedBy     User?           @relation("ExpenseApprover", fields: [approvedById], references: [id])
  attachments    ExpenseAttachment[]

  @@index([organizationId])
  @@index([projectId])
  @@index([projectId, status])
  @@index([budgetCategoryId])
  @@index([submittedById, status]) // For "my expenses" + pending approvals
}

model ExpenseAttachment {
  id         String   @id @default(cuid())
  expenseId  String
  name       String
  mimeType   String
  sizeBytes  Int
  storageKey String
  createdAt  DateTime @default(now())

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
}

model Invoice {
  id               String        @id @default(cuid())
  organizationId   String
  projectId        String
  invoiceNumber    String
  clientName       String
  clientEmail      String?
  clientAddress    String?
  issueDate        DateTime
  dueDate          DateTime
  paymentTerms     PaymentTerms  @default(NET_30)
  status           InvoiceStatus @default(DRAFT)
  subtotalCents    Int           @default(0)
  taxRateBasisPoints Int         @default(0) // e.g. 1600 = 16.00%
  taxAmountCents   Int           @default(0)
  totalCents       Int           @default(0)
  balanceDueCents  Int           @default(0) // Denormalized for AR aging queries
  notes            String?
  sentAt           DateTime?
  viewedAt         DateTime?
  paidAt           DateTime?
  deletedAt        DateTime?     // Soft delete
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  project   Project           @relation(fields: [projectId], references: [id])
  lineItems InvoiceLineItem[]
  payments  Payment[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, dueDate]) // For AR aging queries
  @@index([organizationId, status, dueDate]) // For overdue + aging compound queries
  @@index([projectId])
  @@index([projectId, status])
}

model InvoiceLineItem {
  id                    String @id @default(cuid())
  invoiceId             String
  description           String
  quantityThousandths   Int    // 2500 = 2.5 units
  unitPriceCents        Int
  amountCents           Int
  sortOrder             Int    @default(0)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id             String   @id @default(cuid())
  invoiceId      String
  amountCents    Int
  paymentDate    DateTime
  paymentMethod  String?  // e.g. "bank_transfer", "check", "credit_card"
  reference      String?  // Transaction reference number
  notes          String?
  createdAt      DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

model FinancialAuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  action         String   // e.g. "invoice.created", "payment.recorded", "expense.approved"
  entityType     String
  entityId       String
  beforeData     Json?    // State before change
  afterData      Json?    // State after change
  ipAddress      String?
  createdAt      DateTime @default(now())

  // No update or delete - immutable audit trail
  // No relations to prevent cascade deletes

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}
